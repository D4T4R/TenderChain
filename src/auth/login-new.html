<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Tender Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            animation: fadeIn 0.8s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .metamask-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .metamask-status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        .connect-btn {
            background: #f6851b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-bottom: 15px;
        }

        .connect-btn:hover:not(:disabled) {
            background: #e2761b;
        }

        .connect-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .user-type-selector {
            display: flex;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e1e5e9;
        }

        .user-type-option {
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            color: #495057;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .user-type-option.active {
            background: #667eea;
            color: white;
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .login-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .register-link {
            text-align: center;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }

        .register-link:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .account-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-size: 12px;
            color: #0c5460;
        }

        .verification-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
        }

        .verification-status.verified {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .verification-status.unverified {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="header">
            <h1>Login</h1>
            <p>Access the Tender Management System</p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="metamask-section">
            <div class="metamask-status">
                <div class="status-indicator disconnected" id="statusIndicator"></div>
                <span id="statusText">MetaMask Not Connected</span>
            </div>
            <button type="button" class="connect-btn" id="connectBtn">Connect MetaMask</button>
            
            <div class="account-info" id="accountInfo" style="display: none;">
                <div id="accountAddress"></div>
                <div class="verification-status unverified" id="verificationStatus">
                    Verification Status: Unknown
                </div>
            </div>
        </div>

        <div class="user-type-selector">
            <button type="button" class="user-type-option active" data-type="contractor">
                Contractor/Bidder
            </button>
            <button type="button" class="user-type-option" data-type="officer">
                Government Officer
            </button>
            <button type="button" class="user-type-option" data-type="verifier">
                Verifier
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Checking your account...</p>
        </div>

        <button type="button" class="login-btn" id="loginBtn" disabled>
            Login to Dashboard
        </button>

        <p style="text-align: center; color: #666; font-size: 14px;">
            Don't have an account? <a href="register.html" class="register-link">Register here</a>
        </p>
    </div>

    <!-- Include Web3 -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>

    <script>
        // Simple Web3 Manager for login
        class SimpleWeb3Manager {
            constructor() {
                this.web3 = null;
                this.account = null;
                this.isInitialized = false;
                this.networkConfig = {
                    chainId: 1755516815265,
                    rpcUrl: "http://localhost:8545"
                };
            }

            async init() {
                try {
                    if (typeof window.ethereum !== 'undefined') {
                        this.web3 = new Web3(window.ethereum);
                        
                        // Request account access
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                        this.account = accounts[0];
                        
                        this.isInitialized = true;
                        console.log('Web3Manager initialized successfully');
                        return true;
                    } else {
                        throw new Error('MetaMask not detected');
                    }
                } catch (error) {
                    console.error('Failed to initialize Web3:', error);
                    throw error;
                }
            }

            getCurrentAccount() {
                return this.account;
            }

            async checkVerificationStatus(userType = 'contractor') {
                // For now, return false since verification is not yet implemented
                // This would connect to the actual contract methods
                return false;
            }
        }

        // Initialize global Web3 manager
        window.web3Manager = new SimpleWeb3Manager();

        class LoginManager {
            constructor() {
                this.userType = 'contractor';
                this.isConnected = false;
                this.currentAccount = null;
                this.isVerified = false;
                
                this.initializeUI();
                this.bindEvents();
            }

            initializeUI() {
                this.updateConnectButton();
                this.updateLoginButton();
            }

            bindEvents() {
                // User type selector
                document.querySelectorAll('.user-type-option').forEach(btn => {
                    btn.addEventListener('click', (e) => this.selectUserType(e.target.dataset.type));
                });

                // Connect MetaMask
                document.getElementById('connectBtn').addEventListener('click', () => this.connectMetaMask());

                // Login button
                document.getElementById('loginBtn').addEventListener('click', () => this.handleLogin());

                // Listen for account changes
                window.addEventListener('accountChanged', (e) => {
                    this.currentAccount = e.detail.account;
                    this.updateAccountInfo();
                    this.checkVerificationStatus();
                });
            }

            selectUserType(type) {
                this.userType = type;

                // Update UI
                document.querySelectorAll('.user-type-option').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-type="${type}"]`).classList.add('active');

                // Recheck verification status if connected
                if (this.isConnected) {
                    this.checkVerificationStatus();
                }
            }

            async connectMetaMask() {
                try {
                    if (typeof window.ethereum === 'undefined') {
                        this.showError('MetaMask is not installed. Please install MetaMask to continue.');
                        return;
                    }

                    this.showLoading(true);

                    // Wait for web3Manager to be initialized
                    if (!window.web3Manager || !window.web3Manager.isInitialized) {
                        await window.web3Manager.init();
                    }

                    this.isConnected = true;
                    this.currentAccount = window.web3Manager.getCurrentAccount();
                    
                    this.updateConnectButton();
                    this.updateAccountInfo();
                    
                    // Check verification status
                    await this.checkVerificationStatus();
                    
                    this.updateLoginButton();
                    this.showLoading(false);
                    this.showSuccess('MetaMask connected successfully!');
                    
                } catch (error) {
                    this.showLoading(false);
                    console.error('Failed to connect MetaMask:', error);
                    this.showError('Failed to connect MetaMask. Please try again.');
                }
            }

            async checkVerificationStatus() {
                if (!this.isConnected || !window.web3Manager) {
                    return;
                }

                try {
                    this.isVerified = await window.web3Manager.checkVerificationStatus(this.userType);
                    this.updateVerificationStatus();
                } catch (error) {
                    console.error('Failed to check verification status:', error);
                    this.isVerified = false;
                    this.updateVerificationStatus();
                }
            }

            updateConnectButton() {
                const connectBtn = document.getElementById('connectBtn');
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');

                if (this.isConnected) {
                    connectBtn.textContent = 'Connected';
                    connectBtn.disabled = true;
                    statusIndicator.className = 'status-indicator connected';
                    statusText.textContent = 'MetaMask Connected';
                } else {
                    connectBtn.textContent = 'Connect MetaMask';
                    connectBtn.disabled = false;
                    statusIndicator.className = 'status-indicator disconnected';
                    statusText.textContent = 'MetaMask Not Connected';
                }
            }

            updateAccountInfo() {
                const accountInfo = document.getElementById('accountInfo');
                const accountAddress = document.getElementById('accountAddress');
                
                if (this.currentAccount) {
                    accountAddress.textContent = `Account: ${this.currentAccount.substring(0, 6)}...${this.currentAccount.substring(38)}`;
                    accountInfo.style.display = 'block';
                }
            }

            updateVerificationStatus() {
                const verificationStatus = document.getElementById('verificationStatus');
                
                if (this.isVerified) {
                    verificationStatus.className = 'verification-status verified';
                    verificationStatus.textContent = 'Verification Status: Verified âœ“';
                } else {
                    verificationStatus.className = 'verification-status unverified';
                    verificationStatus.textContent = 'Verification Status: Pending Verification';
                }
            }

            updateLoginButton() {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.disabled = !this.isConnected;
            }

            async handleLogin() {
                if (!this.isConnected) {
                    this.showError('Please connect MetaMask first.');
                    return;
                }

                this.showLoading(true);
                this.hideMessages();

                try {
                    // Check verification status one more time
                    await this.checkVerificationStatus();

                    // Redirect based on user type and verification status
                    let redirectUrl;
                    
                    if (this.userType === 'contractor') {
                        redirectUrl = this.isVerified ? 'dashboardContractor-modern.html' : 'dashboardNormal.html';
                    } else if (this.userType === 'verifier') {
                        redirectUrl = this.isVerified ? 'dashboardVerifier-modern.html' : 'dashboardNormal.html';
                    } else {
                        redirectUrl = this.isVerified ? 'dashboardGovernmentOfficer-modern.html' : 'dashboardNormal.html';
                    }

                    this.showLoading(false);
                    this.showSuccess('Login successful! Redirecting...');
                    
                    // Store login state
                    localStorage.setItem('userType', this.userType);
                    localStorage.setItem('userAccount', this.currentAccount);
                    localStorage.setItem('isVerified', this.isVerified);
                    
                    // Redirect after 2 seconds
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 2000);
                    
                } catch (error) {
                    this.showLoading(false);
                    console.error('Login failed:', error);
                    this.showError(`Login failed: ${error.message}`);
                }
            }

            showLoading(show) {
                const loading = document.getElementById('loading');
                const loginBtn = document.getElementById('loginBtn');
                
                if (show) {
                    loading.style.display = 'block';
                    loginBtn.disabled = true;
                } else {
                    loading.style.display = 'none';
                    loginBtn.disabled = !this.isConnected;
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
            }

            hideMessages() {
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('successMessage').style.display = 'none';
            }
        }

        // Initialize login manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.loginManager = new LoginManager();
            
            // Check if web3Manager is already connected
            setTimeout(() => {
                if (window.web3Manager && window.web3Manager.isInitialized) {
                    window.loginManager.isConnected = true;
                    window.loginManager.currentAccount = window.web3Manager.getCurrentAccount();
                    window.loginManager.updateConnectButton();
                    window.loginManager.updateAccountInfo();
                    window.loginManager.checkVerificationStatus();
                    window.loginManager.updateLoginButton();
                }
            }, 1000);
        });
    </script>
</body>
</html>
